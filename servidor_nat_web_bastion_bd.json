{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "Criando servidores Bastion, Web e de Banco de Dados",
	"Parameters": {
		"FaixaIPVPC": {
			"Description": "Faixa IP Utilizada no VPC",
			"Type": "String",
			"Default": "192.168.0.0/16",
         	"AllowedValues": ["10.0.0.0/16", "172.16.0.0/16", "192.168.0.0/16"]
		},
		"FaixaIPSubredePublica": {
			"Description": "Faixa IP Utilizada na Subrede Publica",
			"Type": "String",
			"Default": "10.0.10.0/24",
         	"AllowedValues": ["10.0.10.0/24", "172.16.10.0/24", "192.168.10.0/24"]
		},
		"FaixaIPSubredePrivada": {
			"Description": "Faixa IP Utilizada na Subrede Privada",
			"Type": "String",
			"Default": "10.0.20.0/24",
         	"AllowedValues": ["10.0.20.0/24", "172.16.20.0/24", "192.168.20.0/24"]
		},
      	"ZonaSubrede": {
         	"Description": "Zona da Subrede",
         	"Type": "Number",
         	"Default": 1
      	},
		"KeyName": {
			"Description": "Nome do par de chaves",
			"Type": "AWS::EC2::KeyPair::KeyName",
			"Default": "mykey"
		},
	   "InstanceType": {
			"Description": "Tipo de instancia",
			"Type": "String",
			"Default": "t2.micro",
			"AllowedValues": ["t2.micro", "t2.small", "t2.medium"]
		},
      	"ImageId": {
         	"Description": "Identificador da Imagem",
         	"Type": "String",
         	"Default": "ami-024a64a6685d05041"
      	},
      	"WordPressUser": {
      		"Description": "Usuario do Wordpress",
      		"Type": "String",
      		"Default": "wordpress"
      	},
      	"WordPressPassword": {
      		"Description": "Senha do usuario Wordpress",
      		"Type": "String",
      		"Default": "wordpress"
      	},
      	"NomeDoProjeto": {
         	"Description": "Nome a ser usado como tag",
         	"Type": "String",
         	"Default": "Bastion com NAT"
      }

    },
	"Resources": {
		"NovoVPC": {
			"Type": "AWS::EC2::VPC",
			"Properties": {
            "CidrBlock": {"Ref": "FaixaIPVPC"},
            "Tags": [{"Key": "Name", "Value": "NovoVPC"}]
			}
		},
      	"SubredePublica": {
         	"Type": "AWS::EC2::Subnet",
         	"Properties": {
            	"VpcId": {"Ref": "NovoVPC"},
            	"CidrBlock": {"Ref": "FaixaIPSubredePublica"},
            	"Tags": [{"Key": "Name", "Value": { "Fn::Join": ["", [ {"Ref": "NomeDoProjeto"},"Publica"]]}}],
            	"AvailabilityZone": {
               		"Fn::Select" : [
                  		{"Ref": "ZonaSubrede"},
                  	{
                     "Fn::GetAZs": ""
                  }
               ]
            } 
         }
      	},
      	"SubredePrivada": {
        	"Type": "AWS::EC2::Subnet",
         	"Properties": {
            	"VpcId": {"Ref": "NovoVPC"},
            	"CidrBlock": {"Ref": "FaixaIPSubredePrivada"},
            	"Tags": [{"Key": "Name", "Value": { "Fn::Join": ["", [ {"Ref": "NomeDoProjeto"},"Privada"]]}}],
            	"AvailabilityZone": {
               		"Fn::Select" : [
                  	{"Ref": "ZonaSubrede"},
                  	{
                     "Fn::GetAZs": ""
                  }
               ]
            } 
         }
      	},
      	"RoteadorInternet":{
         	"Type": "AWS::EC2::InternetGateway",
         	"Properties": {
            	"Tags": [{ "Key": "Name", "Value": {"Ref": "NomeDoProjeto"}}]
         	}
      	},
        "LigacaoRoteadorVPC": {
         	"Type": "AWS::EC2::VPCGatewayAttachment",
         	"Properties": {
            	"InternetGatewayId": {"Ref": "RoteadorInternet"},
            	"VpcId": {"Ref": "NovoVPC"}
         	}
        },
        "TabelaRoteamento": {
         "Type": "AWS::EC2::RouteTable",
         "Properties": {
            "VpcId": {"Ref": "NovoVPC"}
         }
        },
        "IpElastico": {
        	"Type": "AWS::EC2::EIP",
        	"DependsOn": "LigacaoRoteadorVPC",
         	"Properties": {
            	"Domain": "vpc"
         	}
      	},
      	"TabelaRoteamentoPublica": {
        	"Type": "AWS::EC2::RouteTable",
        	"Properties": {
            	"VpcId": {"Ref": "NovoVPC"},
            	"Tags": [{"Key": "Name", "Value": { "Fn::Join": ["", [ {"Ref": "NomeDoProjeto"},"Publica"]]}}]
         	}
      	},
      	"EntradaTabelaRoteamentoPublica": {
        	"Type": "AWS::EC2::Route",
        	"Properties": {
            	"GatewayId": {"Ref": "RoteadorInternet"},
            	"DestinationCidrBlock" : "0.0.0.0/0",
            	"RouteTableId": {"Ref": "TabelaRoteamentoPublica"}
         	}
      	},
      	"LigacaoTabelaSubRedePublica": {
        	"Type": "AWS::EC2::SubnetRouteTableAssociation",
        	"Properties": {
            	"SubnetId": {"Ref": "SubredePublica"},
            	"RouteTableId": {"Ref": "TabelaRoteamentoPublica"}
         	}
      	},
      	"TabelaRoteamentoPrivada": {
        	"Type": "AWS::EC2::RouteTable",
        	"Properties": {
            	"VpcId": {"Ref": "NovoVPC"},
            	"Tags": [{"Key": "Name", "Value": { "Fn::Join": ["", [ {"Ref": "NomeDoProjeto"},"Privada"]]}}]
         	}
      	},
      	"EntradaTabelaRoteamentoPrivada": {
        	"Type": "AWS::EC2::Route",
        	"Properties": {
            	"NatGatewayId": {"Ref": "NAT"},
            	"DestinationCidrBlock" : "0.0.0.0/0",
            	"RouteTableId": {"Ref": "TabelaRoteamentoPrivada"}
         	}
      	},
      	"LigacaoTabelaSubRedePrivada": {
        	"Type": "AWS::EC2::SubnetRouteTableAssociation",
        	"Properties": {
            	"SubnetId": {"Ref": "SubredePrivada"},
            	"RouteTableId": {"Ref": "TabelaRoteamentoPrivada"}
         	}
      	},
	    "GrupoDeSegurancaBastion": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"GroupDescription": "Bastion",
				"VpcId": {"Ref": "NovoVPC"}
			}
	    },
		"PermitirSSHnoBastion": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {"Ref": "GrupoDeSegurancaBastion"},
				"IpProtocol": "tcp",
				"FromPort": "22",
				"ToPort": "22",
				"CidrIp": "0.0.0.0/0"
			}
	    },
		"GrupoDeSegurancaWeb": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"GroupDescription": "Web",
				"VpcId": {"Ref": "NovoVPC"}
			}
	    },
		"PermitirSSHNoServidorWebViaBastion": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {"Ref": "GrupoDeSegurancaWeb"},
				"IpProtocol": "tcp",
				"FromPort": "22",
				"ToPort": "22",
				"SourceSecurityGroupId": {"Ref": "GrupoDeSegurancaBastion"}
			}
		},
		"PermitirAcessoWeb": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {"Ref": "GrupoDeSegurancaWeb"},
				"CidrIp": "0.0.0.0/0",
				"IpProtocol": "tcp",
				"FromPort": "80",
				"ToPort": "80"
			}
		},
		"GrupoDeSegurancaBD": {
			"Type": "AWS::EC2::SecurityGroup",
			"Properties": {
				"GroupDescription": "MySQL",
				"VpcId": {"Ref": "NovoVPC"}
			}
		},
		"LiberarBancoAoServidorWeb":{
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {"Ref": "GrupoDeSegurancaBD"},
				"IpProtocol": "tcp",
				"FromPort": "3306",
				"ToPort": "3306",
				"SourceSecurityGroupId": {"Ref": "GrupoDeSegurancaWeb"}
			}
		},
		"LiberarSSHnoBancoViaBastion": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {"Ref": "GrupoDeSegurancaBD"},
				"IpProtocol": "tcp",
				"FromPort": "22",
				"ToPort": "22",
				"SourceSecurityGroupId": {"Ref": "GrupoDeSegurancaBastion"}
			}
		},
		"ServidorBastion": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"ImageId": {"Ref":"ImageId"},
				"InstanceType": {"Ref": "InstanceType"},
				"KeyName": {"Ref": "KeyName"},
				"NetworkInterfaces": [{
					"AssociatePublicIpAddress": "true",
					"DeleteOnTermination": "true",
					"SubnetId": {"Ref": "SubredePublica"},
					"DeviceIndex": "0",
					"GroupSet": [{"Ref": "GrupoDeSegurancaBastion"}]
            	}]
			}
		},
		"ServidorBD": {
         "Type": "AWS::EC2::Instance",
         "Properties": {
            "ImageId": {"Ref":"ImageId"},
            "InstanceType": {"Ref": "InstanceType"},
            "KeyName": {"Ref": "KeyName"},
            "NetworkInterfaces": [{
               "AssociatePublicIpAddress": "true",
               "DeleteOnTermination": "true",
               "SubnetId": {"Ref": "SubredePrivada"},
               "DeviceIndex": "0",
               "GroupSet": [{"Ref": "GrupoDeSegurancaBD"}]
            }],
            "UserData" : {"Fn::Base64": { "Fn::Join": ["", [
                                     "#!/bin/bash -ex \n",
                                     "wget https://raw.githubusercontent.com/denyspmaciel/Topicos-Avancados/master/instalaBancoWordpress.shhttps%3A/github.com/denyspmaciel/Topicos-Avancados/blob/master/bancoWordpress.sh \n",
                                     "chmod +x bancoWordpress.sh \n",
                                     "./bancoWordpress.sh \n"
                                 ]]}}
         }
      	},
		"ServidorWeb": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"ImageId": {"Ref":"ImageId"},
				"InstanceType": {"Ref": "InstanceType"},
				"KeyName": {"Ref": "KeyName"},
				"NetworkInterfaces": [{
					"AssociatePublicIpAddress": "true",
					"DeleteOnTermination": "true",
					"SubnetId": {"Ref": "SubredePublica"},
					"DeviceIndex": "0",
					"GroupSet": [{"Ref": "GrupoDeSegurancaWeb"}]
            }],
            "UserData": {"Fn::Base64": { "Fn::Join": ["", [
               "#!/bin/bash -ex \n",
               "export IPBD=", {"Fn::GetAtt": ["ServidorBD", "PrivateIp"]}, "\n",
               "wget https://raw.githubusercontent.com/denyspmaciel/Topicos-Avancados/master/wordpress_bd_bastion.sh \n",
               "chmod +x wordpress_bd_bastion.sh \n",
               "./wordpress_bd_bastion.sh \n"
           					]]}}
        		}
    	}
    },
	"Outputs": {
		"IpPublicoWeb": {
			"Value": {"Fn::GetAtt": ["ServidorWeb", "PublicIp"]},
			"Description": "IP publico do servidor Web"
		},
		"IpPrivadoWeb": {
			"Value": {"Fn::GetAtt": ["ServidorWeb", "PrivateIp"]},
			"Description": "IP privado do servidor Web"
		},
		"IpPrivadoBD": {
			"Value": {"Fn::GetAtt": ["ServidorBD", "PrivateIp"]},
			"Description": "IP privado do servidor de banco de dados"
		},
		"IpPublicoBastion": {
			"Value": {"Fn::GetAtt": ["ServidorBastion", "PublicIp"]},
			"Description": "IP publico do servidor Bastion"
		}

	}
}
